@{
    ViewBag.Title = "主页";
}

<h2>@ViewBag.Message <a href="http://xiechengxiong.com/234.html" target="_blank">瀑布流布局</a></h2>

@*引入js*@
<script src="../../Scripts/jufine.waterfall.arrayExten.js"></script>
<script src="../../Scripts/jufine.waterfall.pageInfo.js"></script>
<script src="../../Scripts/jufine.waterfall.core.js"></script>
<script src="../../Scripts/jufine.waterfall.main.js"></script>

@*引入样式*@
<link href="../../Content/jufine.waterfall.css" rel="stylesheet" />

@*瀑布流布局*@
<div id="waterfallDemo" style="width: 100%">
    @*记录当前记录条数*@
    <input type="hidden" id="hdCurrItemCount" value="0" />
    @*放置瀑布流条目的容器*@
    <div class="wrap" id="container" style="visibility: visible; position: relative; align-items: center; width: 100%">
    </div>
    @*正在加载的图片*@
    <div class="loading" id="loading" style="display: none;">
        <img id="loadingImage" src="../../images/loading.gif" alt="数据加载中。。。" />
    </div>
</div>

<script type="text/javascript">

    var pageNumber = 1;

    var container = X.$('container');
    var loading = X.$('loading');

    var pageMess = PageInfo.GetImageWidthAndColumnSpace(container.offsetWidth);

    var _columnSpace = pageMess.ColumnSpace;
    var _columnWidth = pageMess.ImageWidth;
    var _itemSelector = 'item';

    var hasErrorOrNoData = false;

    var currObj = new Waterfall(container, {
        itemSelector: _itemSelector,
        columnWidth: _columnWidth,
        columnSpace: _columnSpace,
        load: function (success) {
            //显示图标---数据加载中
            loading.style.display = '';

            //设置传递参数
            var queryData = new Array(3);
            queryData.push('PageNumber=' + pageNumber);
            queryData.push('ImageWidth=' + _columnWidth);
            queryData.push('CurrItemCount=' + X.$('hdCurrItemCount').value);
            var queryDataStr = queryData.join('&');

            currObj.setLoading(true);

            //异步获取图片列表
            X.ajax({
                url: "Home/GetWaterfallImageInfos",
                type: "GET",
                data: queryDataStr,
                dataType: "json",
                failFn: function () {
                    hasErrorOrNoData = true;
                    alert('异步数据加载出错，请稍后再试');
                    currObj.setLoading(false);
                },
                sucFn: function (data) {
                    if (data == null) {
                        hasErrorOrNoData = true;
                        alert("没有更多的数据了,请稍后再试");
                        loading.style.display = 'none';
                        return;
                    }
                    hasErrorOrNoData = false;
                    var div = document.createElement('div');
                    div.style.visibility = 'hidden';
                    for (var i = 0; i < data.photos.length; i++) {
                        var item = document.createElement('div');
                        item.className = 'item';
                        item.width = _columnWidth;

                        item.innerHTML = '<img src="' + data.photos[i].src + '" alt="" width="' + _columnWidth + '" />';
                        item.innerHTML += '<div style="width:' + _columnWidth + 'px;overflow:visible;text-overflow:inherit;">' + data.photos[i].title + '</div>';

                        div.appendChild(item);
                    }
                    container.appendChild(div);
                    success && success(div);

                    pageNumber++;

                    //页面显示信息设置
                    document.getElementById('hdCurrItemCount').value = parseInt(document.getElementById('hdCurrItemCount').value) + parseInt(data.pageCount);
                    currObj.setLoading(false);
                }
            });

            window.setTimeout(function () {

            }, 5000);
        },
        complete: function (obj) {
            obj.style.visibility = 'visible';
            loading.style.display = 'none';
            PageInfo.IsInBottom(function (inBottom) {
                if (inBottom) {
                    PageInfo.SetScrollTop(1);
                }
            });
        }
    });

    PageInfo.SetInterval(function () {
        PageInfo.IsInBottom(function (inBottom) {
            if (inBottom) {
                PageInfo.SetScrollTop(30);
            }
        });
    },
    function () {
        return false;
    },
    2000);

    //currObj.loadData();
    //加载一批数据,直到出现滚动条为止
    PageInfo.SetInterval(
        function () {
            if (loading.style.display == 'none') {
                currObj.loadData();
            }
        },
        function () {
            return !hasErrorOrNoData && (PageInfo.GetScrollHeight() > PageInfo.GetWindowHeight());
        },
        1000
    );

    //窗体尺寸改变时重新加载页面，延迟500ms执行
    window.onresize = function () {
        var currItemCount = parseInt(X.$('hdCurrItemCount').value);
        loading.style.display = '';
        if (currItemCount > 0) {
            setTimeout(function () {
                window.location.reload();
            }, 500);
        }
    };
</script>
